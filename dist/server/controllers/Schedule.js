'use strict';
Object.defineProperty(exports, "__esModule", { value: true });
const util = require("util");
const db = require("../db");
const mongodb_1 = require("mongodb");
const OK = 200;
const BadRequest = 400;
const InternalServerError = 500;
const inspect = (input) => util.inspect(input, false, Infinity, true);
module.exports.CreateSchedule = function (req, res) {
    // print out the params
    console.log(util.inspect(req.swagger.params, false, Infinity, true));
    res.setHeader('Content-Type', 'application/json');
    if (!req.session) {
        res.status(BadRequest);
        res.send(JSON.stringify({ message: "Invalid session" }, null, 2));
        res.end();
    }
    if (!req.session.email) {
        res.status(BadRequest);
        res.send(JSON.stringify({ message: "Login required" }, null, 2));
        res.end();
    }
    if (req.swagger.params.schedule.value.schedule_name && req.swagger.params.schedule.value.average_appointment_length && req.swagger.params.schedule.value.M_START && req.swagger.params.schedule.value.M_END && req.swagger.params.schedule.value.T_START && req.swagger.params.schedule.value.T_END && req.swagger.params.schedule.value.W_START && req.swagger.params.schedule.value.W_END && req.swagger.params.schedule.value.Th_START && req.swagger.params.schedule.value.Th_END && req.swagger.params.schedule.value.F_START && req.swagger.params.schedule.value.F_END && req.swagger.params.schedule.value.S_START && req.swagger.params.schedule.value.S_END && req.swagger.params.schedule.value.Su_START && req.swagger.params.schedule.value.Su_END) {
        var scheduleObject = req.swagger.params.schedule.value;
        scheduleObject.schedulerID = new mongodb_1.ObjectID(req.session.logid);
        db.Schedule.insertOne(scheduleObject, function (err, result) {
            if (err) {
                res.status(InternalServerError);
                res.send(JSON.stringify({ message: inspect(err) }, null, 2));
                res.end();
            }
            if (!result) {
                res.status(BadRequest);
                res.send(JSON.stringify({ message: "Create Schedule Failed" }, null, 2));
                res.end();
            }
            else {
                res.status(OK);
                res.send(JSON.stringify({ message: "Schedule Inserted Successfully " }, null, 2));
                res.end();
                console.log("1 document inserted");
            }
        });
    }
};
module.exports.deleteSchedule = function (req, res) {
    // print out the params 
    console.log(util.inspect(req.swagger.params, false, Infinity, true));
    res.setHeader('Content-Type', 'application/json');
    var scheduleObject = req.swagger.params.schedule.value;
    // Check that we're logged in
    if (!req.session || !req.session.email) {
        // no session or yes session and no username
        res.status(BadRequest);
        res.send(JSON.stringify({ message: "You are not currently logged in, login in to delete schedule" }, null, 2));
        res.end();
        return;
    }
    // Check that the schedule exists and actually belongs to this scheduler.
    db.Schedule.findOne({ _id: new mongodb_1.ObjectID(scheduleObject._id) }, function (err, result) {
        // TODO: check to see if result is a thing.
        if (err) {
            res.status(InternalServerError);
            res.send(JSON.stringify({ message: inspect(err) }, null, 2));
            res.end();
        }
        if (!result) {
            res.status(BadRequest);
            res.send(JSON.stringify({ message: "Schedule Doesnt Exist" }, null, 2));
            res.end();
        }
        else {
            // TODO: check to see if Schedule belongs to this user.
            if (!result.schedulerID.equals(req.session.logid)) {
                res.status(BadRequest);
                res.send(JSON.stringify({ message: "This schedule doesnt belong to the current user" }, null, 2));
                res.end();
            }
            else {
                db.Schedule.deleteOne({ _id: new mongodb_1.ObjectID(scheduleObject._id) }, function (err, result) {
                    if (err) {
                        res.status(InternalServerError);
                        res.send(JSON.stringify({ message: inspect(err) }, null, 2));
                        res.end();
                    }
                    if (!result) {
                        res.status(BadRequest);
                        res.send(JSON.stringify({ message: "Delete Function Failed" }, null, 2));
                        res.end();
                    }
                    else {
                        res.status(OK);
                        res.send(JSON.stringify({ message: "Schedule Deleted Successfully " }, null, 2));
                        res.end();
                        console.log("1 document deleted");
                    }
                });
            }
        }
    });
};
module.exports.removeInterval = function (req, res) {
    // print out the params 
    console.log(util.inspect(req.swagger.params, false, Infinity, true));
    res.setHeader('Content-Type', 'application/json');
    var removeintervalObject = req.swagger.params.removeinterval.value;
    /* Check that we're logged in
    if (!req.session || !req.session.username) {
        // no session or yes session and no username
        res.status(BadRequest)
        res.send(JSON.stringify({ message: "You are not currently logged in, login in to remove interval" }, null, 2))
        res.end()
        return;
    }
    */
    // Check that the schedule exists and actually belongs to this scheduler.
    db.Schedule.findOne({ _id: new mongodb_1.ObjectID(removeintervalObject.s_id) }, function (err, result) {
        // TODO: check to see if result is a thing.
        if (err) {
            res.status(InternalServerError);
            res.send(JSON.stringify({ message: inspect(err) }, null, 2));
            res.end();
        }
        if (!result) {
            res.status(BadRequest);
            res.send(JSON.stringify({ message: "Schedule Doesnt Exist" }, null, 2));
            res.end();
        }
        else {
            // TODO: check to see if Schedule belongs to this user.
            if (!result.schedulerID.equals(req.session.logid)) {
                res.status(BadRequest);
                res.send(JSON.stringify({ message: "This schedule doesnt belong to the current user" }, null, 2));
                res.end();
            }
            else {
                db.Reservation.insertOne(removeintervalObject, function (err, result) {
                    if (err) {
                        res.status(InternalServerError);
                        res.send(JSON.stringify({ message: inspect(err) }, null, 2));
                        res.end();
                    }
                    if (!result) {
                        res.status(BadRequest);
                        res.send(JSON.stringify({ message: "Remove Interval Function Failed" }, null, 2));
                        res.end();
                    }
                    else {
                        res.status(OK);
                        res.send(JSON.stringify({ message: "Removed Interval Successfully " }, null, 2));
                        res.end();
                    }
                });
            }
        }
    });
};

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9zZXJ2ZXIvY29udHJvbGxlcnMvU2NoZWR1bGUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsWUFBWSxDQUFDOztBQUViLDZCQUE2QjtBQUc3Qiw0QkFBNEI7QUFTNUIscUNBTWlCO0FBRWpCLE1BQU0sRUFBRSxHQUFHLEdBQUcsQ0FBQTtBQUNkLE1BQU0sVUFBVSxHQUFHLEdBQUcsQ0FBQTtBQUN0QixNQUFNLG1CQUFtQixHQUFHLEdBQUcsQ0FBQTtBQUUvQixNQUFNLE9BQU8sR0FBRyxDQUFDLEtBQVUsRUFBRSxFQUFFLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxLQUFLLEVBQUUsS0FBSyxFQUFFLFFBQVEsRUFBRSxJQUFJLENBQUMsQ0FBQTtBQWtCMUUsTUFBTSxDQUFDLE9BQU8sQ0FBQyxjQUFjLEdBQUcsVUFBVSxHQUF1RSxFQUFFLEdBQXFCO0lBRXBJLHVCQUF1QjtJQUN2QixPQUFPLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLE9BQU8sQ0FBQyxNQUFNLEVBQUUsS0FBSyxFQUFFLFFBQVEsRUFBRSxJQUFJLENBQUMsQ0FBQyxDQUFBO0lBQ3BFLEdBQUcsQ0FBQyxTQUFTLENBQUMsY0FBYyxFQUFFLGtCQUFrQixDQUFDLENBQUE7SUFFN0MsSUFBSSxDQUFDLEdBQUcsQ0FBQyxPQUFPLEVBQUU7UUFDZCxHQUFHLENBQUMsTUFBTSxDQUFDLFVBQVUsQ0FBQyxDQUFBO1FBQ3RCLEdBQUcsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxFQUFFLE9BQU8sRUFBRSxpQkFBaUIsRUFBRSxFQUFFLElBQUksRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFBO1FBQ2pFLEdBQUcsQ0FBQyxHQUFHLEVBQUUsQ0FBQTtLQUNaO0lBQ0QsSUFBSSxDQUFDLEdBQUcsQ0FBQyxPQUFPLENBQUMsS0FBSyxFQUFFO1FBQ3BCLEdBQUcsQ0FBQyxNQUFNLENBQUMsVUFBVSxDQUFDLENBQUE7UUFDdEIsR0FBRyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLEVBQUUsT0FBTyxFQUFFLGdCQUFnQixFQUFFLEVBQUUsSUFBSSxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUE7UUFDaEUsR0FBRyxDQUFDLEdBQUcsRUFBRSxDQUFBO0tBQ1o7SUFDRCxJQUFJLEdBQUcsQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUFDLFFBQVEsQ0FBQyxLQUFLLENBQUMsYUFBYSxJQUFJLEdBQUcsQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUFDLFFBQVEsQ0FBQyxLQUFLLENBQUMsMEJBQTBCLElBQUksR0FBRyxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsUUFBUSxDQUFDLEtBQUssQ0FBQyxPQUFPLElBQUksR0FBRyxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsUUFBUSxDQUFDLEtBQUssQ0FBQyxLQUFLLElBQUksR0FBRyxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsUUFBUSxDQUFDLEtBQUssQ0FBQyxPQUFPLElBQUksR0FBRyxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsUUFBUSxDQUFDLEtBQUssQ0FBQyxLQUFLLElBQUksR0FBRyxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsUUFBUSxDQUFDLEtBQUssQ0FBQyxPQUFPLElBQUksR0FBRyxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsUUFBUSxDQUFDLEtBQUssQ0FBQyxLQUFLLElBQUksR0FBRyxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsUUFBUSxDQUFDLEtBQUssQ0FBQyxRQUFRLElBQUksR0FBRyxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsUUFBUSxDQUFDLEtBQUssQ0FBQyxNQUFNLElBQUksR0FBRyxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsUUFBUSxDQUFDLEtBQUssQ0FBQyxPQUFPLElBQUksR0FBRyxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsUUFBUSxDQUFDLEtBQUssQ0FBQyxLQUFLLElBQUksR0FBRyxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMs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LENBQ0osQ0FBQTtBQUNMLENBQUMsQ0FBQyIsImZpbGUiOiJzZXJ2ZXIvY29udHJvbGxlcnMvU2NoZWR1bGUuanMiLCJzb3VyY2VzQ29udGVudCI6WyIndXNlIHN0cmljdCc7XG5cbmltcG9ydCB1dGlsID0gcmVxdWlyZSgndXRpbCcpXG5pbXBvcnQgZXhwcmVzcyA9IHJlcXVpcmUoJ2V4cHJlc3MnKVxuaW1wb3J0IHN3YWdnZXJUb29scyA9IHJlcXVpcmUoJ3N3YWdnZXItdG9vbHMnKVxuaW1wb3J0IGRiID0gcmVxdWlyZSgnLi4vZGInKVxuaW1wb3J0IGFwaSA9IHJlcXVpcmUoJy4uL2FwaScpXG5pbXBvcnQgQXBpU2NoZWR1bGUgPSBkYi5TY2hlZHVsZVxuaW1wb3J0IEFwaVJlc2VydmF0aW9uID0gZGIuUmVzZXJ2YXRpb25cbmltcG9ydCBBcGlPYmplY3RJRCA9IGRiLk9iamVjdElEXG5pbXBvcnQgQXBpVXNlciA9IGRiLlVzZXJcbmltcG9ydCBBcGlTY2hlZHVsZXIgPSBkYi5TY2hlZHVsZXJcblxuXG5pbXBvcnQge1xuICAgIE1vbmdvRXJyb3IsXG4gICAgRGVsZXRlV3JpdGVPcFJlc3VsdE9iamVjdCxcbiAgICBPYmplY3RJRCBhcyBNb25nb09iamVjdElELFxuICAgIEluc2VydE9uZVdyaXRlT3BSZXN1bHQsXG4gICAgT2JqZWN0SURcbn0gZnJvbSAnbW9uZ29kYic7XG5cbmNvbnN0IE9LID0gMjAwXG5jb25zdCBCYWRSZXF1ZXN0ID0gNDAwXG5jb25zdCBJbnRlcm5hbFNlcnZlckVycm9yID0gNTAwXG5cbmNvbnN0IGluc3BlY3QgPSAoaW5wdXQ6IGFueSkgPT4gdXRpbC5pbnNwZWN0KGlucHV0LCBmYWxzZSwgSW5maW5pdHksIHRydWUpXG5cbi8vIE1ha2Ugc3VyZSB0aGlzIG1hdGNoZXMgdGhlIFN3YWdnZXIuanNvbiBib2R5IHBhcmFtZXRlciBmb3IgdGhlIC9zY2hlZHVsZSBBUElcbmludGVyZmFjZSBDcmVhdGVTY2hlZHVsZVBheWxvYWQge1xuICAgIHNjaGVkdWxlOiBzd2FnZ2VyVG9vbHMuU3dhZ2dlclJlcXVlc3RQYXJhbWV0ZXI8QXBpU2NoZWR1bGU+XG4gICAgW3BhcmFtTmFtZTogc3RyaW5nXTogc3dhZ2dlclRvb2xzLlN3YWdnZXJSZXF1ZXN0UGFyYW1ldGVyPEFwaVNjaGVkdWxlPiB8IHVuZGVmaW5lZDtcbn1cblxuaW50ZXJmYWNlIERlbGV0ZVNjaGVkdWxlUGF5bG9hZCB7XG4gICAgc2NoZWR1bGU6IHN3YWdnZXJUb29scy5Td2FnZ2VyUmVxdWVzdFBhcmFtZXRlcjxBcGlPYmplY3RJRD5cbiAgICBbcGFyYW1OYW1lOiBzdHJpbmddOiBzd2FnZ2VyVG9vbHMuU3dhZ2dlclJlcXVlc3RQYXJhbWV0ZXI8QXBpT2JqZWN0SUQ+IHwgdW5kZWZpbmVkO1xufVxuXG5pbnRlcmZhY2UgUmVtb3ZlSW50ZXJ2YWxQYXlsb2FkIHtcbiAgICByZW1vdmVpbnRlcnZhbDogc3dhZ2dlclRvb2xzLlN3YWdnZXJSZXF1ZXN0UGFyYW1ldGVyPEFwaVNjaGVkdWxlICYgQXBpUmVzZXJ2YXRpb24+XG4gICAgW3BhcmFtTmFtZTogc3RyaW5nXTogc3dhZ2dlclRvb2xzLlN3YWdnZXJSZXF1ZXN0UGFyYW1ldGVyPEFwaVNjaGVkdWxlICYgQXBpUmVzZXJ2YXRpb24+IHwgdW5kZWZpbmVkO1xufVxuXG5tb2R1bGUuZXhwb3J0cy5DcmVhdGVTY2hlZHVsZSA9IGZ1bmN0aW9uIChyZXE6IGFwaS5SZXF1ZXN0ICYgc3dhZ2dlclRvb2xzLlN3YWdnZXIyMFJlcXVlc3Q8Q3JlYXRlU2NoZWR1bGVQYXlsb2FkPiwgcmVzOiBleHByZXNzLlJlc3BvbnNlKSB7XG5cbiAgICAvLyBwcmludCBvdXQgdGhlIHBhcmFtc1xuICAgIGNvbnNvbGUubG9nKHV0aWwuaW5zcGVjdChyZXEuc3dhZ2dlci5wYXJhbXMsIGZhbHNlLCBJbmZpbml0eSwgdHJ1ZSkpXG4gICAgcmVzLnNldEhlYWRlcignQ29udGVudC1UeXBlJywgJ2FwcGxpY2F0aW9uL2pzb24nKVxuXG4gICAgICAgIGlmICghcmVxLnNlc3Npb24pIHtcbiAgICAgICAgICAgIHJlcy5zdGF0dXMoQmFkUmVxdWVzdClcbiAgICAgICAgICAgIHJlcy5zZW5kKEpTT04uc3RyaW5naWZ5KHsgbWVzc2FnZTogXCJJbnZhbGlkIHNlc3Npb25cIiB9LCBudWxsLCAyKSlcbiAgICAgICAgICAgIHJlcy5lbmQoKVxuICAgICAgICB9XG4gICAgICAgIGlmICghcmVxLnNlc3Npb24uZW1haWwpIHtcbiAgICAgICAgICAgIHJlcy5zdGF0dXMoQmFkUmVxdWVzdClcbiAgICAgICAgICAgIHJlcy5zZW5kKEpTT04uc3RyaW5naWZ5KHsgbWVzc2FnZTogXCJMb2dpbiByZXF1aXJlZFwiIH0sIG51bGwsIDIpKVxuICAgICAgICAgICAgcmVzLmVuZCgpXG4gICAgICAgIH1cbiAgICAgICAgaWYgKHJlcS5zd2FnZ2VyLnBhcmFtcy5zY2hlZHVsZS52YWx1ZS5zY2hlZHVsZV9uYW1lICYmIHJlcS5zd2FnZ2VyLnBhcmFtcy5zY2hlZHVsZS52YWx1ZS5hdmVyYWdlX2FwcG9pbnRtZW50X2xlbmd0aCAmJiByZXEuc3dhZ2dlci5wYXJhbXMuc2NoZWR1bGUudmFsdWUuTV9TVEFSVCAmJiByZXEuc3dhZ2dlci5wYXJhbXMuc2NoZWR1bGUudmFsdWUuTV9FTkQgJiYgcmVxLnN3YWdnZXIucGFyYW1zLnNjaGVkdWxlLnZhbHVlLlRfU1RBUlQgJiYgcmVxLnN3YWdnZXIucGFyYW1zLnNjaGVkdWxlLnZhbHVlLlRfRU5EICYmIHJlcS5zd2FnZ2VyLnBhcmFtcy5zY2hlZHVsZS52YWx1ZS5XX1NUQVJUICYmIHJlcS5zd2FnZ2VyLnBhcmFtcy5zY2hlZHVsZS52YWx1ZS5XX0VORCAmJiByZXEuc3dhZ2dlci5wYXJhbXMuc2NoZWR1bGUudmFsdWUuVGhfU1RBUlQgJiYgcmVxLnN3YWdnZXIucGFyYW1zLnNjaGVkdWxlLnZhbHVlLlRoX0VORCAmJiByZXEuc3dhZ2dlci5wYXJhbXMuc2NoZWR1bGUudmFsdWUuRl9TVEFSVCAmJiByZXEuc3dhZ2dlci5wYXJhbXMuc2NoZWR1bGUudmFsdWUuRl9FTkQgJiYgcmVxLnN3YWdnZXIucGFyYW1zLnNjaGVkdWxlLnZhbHVlLlNfU1RBUlQgJiYgcmVxLnN3YWdnZXIucGFyYW1zLnNjaGVkdWxlLnZhbHVlLlNfRU5EICYmIHJlcS5zd2FnZ2VyLnBhcmFtcy5zY2hlZHVsZS52YWx1ZS5TdV9TVEFSVCAmJiByZXEuc3dhZ2dlci5wYXJhbXMuc2NoZWR1bGUudmFsdWUuU3VfRU5EKSB7XG5cbiAgICAgICAgICAgIHZhciBzY2hlZHVsZU9iamVjdCA9IHJlcS5zd2FnZ2VyLnBhcmFtcy5zY2hlZHVsZS52YWx1ZTtcbiAgICAgICAgICAgIHNjaGVkdWxlT2JqZWN0LnNjaGVkdWxlcklEID0gbmV3IE9iamVjdElEKHJlcS5zZXNzaW9uLmxvZ2lkKTtcblxuICAgICAgICAgICAgZGIuU2NoZWR1bGUuaW5zZXJ0T25lKHNjaGVkdWxlT2JqZWN0LCBmdW5jdGlvbiAoZXJyOiBNb25nb0Vycm9yLCByZXN1bHQ6IEluc2VydE9uZVdyaXRlT3BSZXN1bHQpIHtcbiAgICAgICAgICAgICAgICBpZiAoZXJyKSB7XG4gICAgICAgICAgICAgICAgICAgIHJlcy5zdGF0dXMoSW50ZXJuYWxTZXJ2ZXJFcnJvcilcbiAgICAgICAgICAgICAgICAgICAgcmVzLnNlbmQoSlNPTi5zdHJpbmdpZnkoeyBtZXNzYWdlOiBpbnNwZWN0KGVycikgfSwgbnVsbCwgMikpXG4gICAgICAgICAgICAgICAgICAgIHJlcy5lbmQoKVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBpZiAoIXJlc3VsdCkge1xuICAgICAgICAgICAgICAgICAgICByZXMuc3RhdHVzKEJhZFJlcXVlc3QpXG4gICAgICAgICAgICAgICAgICAgIHJlcy5zZW5kKEpTT04uc3RyaW5naWZ5KHsgbWVzc2FnZTogXCJDcmVhdGUgU2NoZWR1bGUgRmFpbGVkXCIgfSwgbnVsbCwgMikpXG4gICAgICAgICAgICAgICAgICAgIHJlcy5lbmQoKVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgcmVzLnN0YXR1cyhPSylcbiAgICAgICAgICAgICAgICAgICAgcmVzLnNlbmQoSlNPTi5zdHJpbmdpZnkoeyBtZXNzYWdlOiBcIlNjaGVkdWxlIEluc2VydGVkIFN1Y2Nlc3NmdWxseSBcIiB9LCBudWxsLCAyKSlcbiAgICAgICAgICAgICAgICAgICAgcmVzLmVuZCgpXG4gICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKFwiMSBkb2N1bWVudCBpbnNlcnRlZFwiKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfVxufTtcblxubW9kdWxlLmV4cG9ydHMuZGVsZXRlU2NoZWR1bGUgPSBmdW5jdGlvbiAocmVxOiBhcGkuUmVxdWVzdCAmIHN3YWdnZXJUb29scy5Td2FnZ2VyMjBSZXF1ZXN0PERlbGV0ZVNjaGVkdWxlUGF5bG9hZD4sIHJlczogZXhwcmVzcy5SZXNwb25zZSkge1xuXG4gICAgLy8gcHJpbnQgb3V0IHRoZSBwYXJhbXMgXG4gICAgY29uc29sZS5sb2codXRpbC5pbnNwZWN0KHJlcS5zd2FnZ2VyLnBhcmFtcywgZmFsc2UsIEluZmluaXR5LCB0cnVlKSlcbiAgICByZXMuc2V0SGVhZGVyKCdDb250ZW50LVR5cGUnLCAnYXBwbGljYXRpb24vanNvbicpXG5cbiAgICB2YXIgc2NoZWR1bGVPYmplY3QgPSByZXEuc3dhZ2dlci5wYXJhbXMuc2NoZWR1bGUudmFsdWU7XG5cbiAgICAvLyBDaGVjayB0aGF0IHdlJ3JlIGxvZ2dlZCBpblxuICAgIGlmICghcmVxLnNlc3Npb24gfHwgIXJlcS5zZXNzaW9uLmVtYWlsKSB7XG4gICAgICAgIC8vIG5vIHNlc3Npb24gb3IgeWVzIHNlc3Npb24gYW5kIG5vIHVzZXJuYW1lXG4gICAgICAgIHJlcy5zdGF0dXMoQmFkUmVxdWVzdClcbiAgICAgICAgcmVzLnNlbmQoSlNPTi5zdHJpbmdpZnkoeyBtZXNzYWdlOiBcIllvdSBhcmUgbm90IGN1cnJlbnRseSBsb2dnZWQgaW4sIGxvZ2luIGluIHRvIGRlbGV0ZSBzY2hlZHVsZVwiIH0sIG51bGwsIDIpKVxuICAgICAgICByZXMuZW5kKClcbiAgICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIC8vIENoZWNrIHRoYXQgdGhlIHNjaGVkdWxlIGV4aXN0cyBhbmQgYWN0dWFsbHkgYmVsb25ncyB0byB0aGlzIHNjaGVkdWxlci5cbiAgICBkYi5TY2hlZHVsZS5maW5kT25lKHsgX2lkOiBuZXcgTW9uZ29PYmplY3RJRChzY2hlZHVsZU9iamVjdC5faWQpIH0sIGZ1bmN0aW9uIChlcnI6IE1vbmdvRXJyb3IsIHJlc3VsdDogQXBpU2NoZWR1bGUgfCBudWxsKSB7XG4gICAgICAgIC8vIFRPRE86IGNoZWNrIHRvIHNlZSBpZiByZXN1bHQgaXMgYSB0aGluZy5cbiAgICAgICAgaWYgKGVycikge1xuICAgICAgICAgICAgcmVzLnN0YXR1cyhJbnRlcm5hbFNlcnZlckVycm9yKVxuICAgICAgICAgICAgcmVzLnNlbmQoSlNPTi5zdHJpbmdpZnkoeyBtZXNzYWdlOiBpbnNwZWN0KGVycikgfSwgbnVsbCwgMikpXG4gICAgICAgICAgICByZXMuZW5kKClcbiAgICAgICAgfVxuICAgICAgICBpZiAoIXJlc3VsdCkge1xuICAgICAgICAgICAgcmVzLnN0YXR1cyhCYWRSZXF1ZXN0KVxuICAgICAgICAgICAgcmVzLnNlbmQoSlNPTi5zdHJpbmdpZnkoeyBtZXNzYWdlOiBcIlNjaGVkdWxlIERvZXNudCBFeGlzdFwiIH0sIG51bGwsIDIpKVxuICAgICAgICAgICAgcmVzLmVuZCgpXG4gICAgICAgIH1cbiAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAvLyBUT0RPOiBjaGVjayB0byBzZWUgaWYgU2NoZWR1bGUgYmVsb25ncyB0byB0aGlzIHVzZXIuXG4gICAgICAgICAgICAgICAgaWYgKCFyZXN1bHQuc2NoZWR1bGVySUQuZXF1YWxzKHJlcS5zZXNzaW9uLmxvZ2lkKSkge1xuICAgICAgICAgICAgICAgICAgICByZXMuc3RhdHVzKEJhZFJlcXVlc3QpXG4gICAgICAgICAgICAgICAgICAgIHJlcy5zZW5kKEpTT04uc3RyaW5naWZ5KHsgbWVzc2FnZTogXCJUaGlzIHNjaGVkdWxlIGRvZXNudCBiZWxvbmcgdG8gdGhlIGN1cnJlbnQgdXNlclwiIH0sIG51bGwsIDIpKVxuICAgICAgICAgICAgICAgICAgICByZXMuZW5kKClcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIGRiLlNjaGVkdWxlLmRlbGV0ZU9uZSh7IF9pZDogbmV3IE1vbmdvT2JqZWN0SUQoc2NoZWR1bGVPYmplY3QuX2lkKSB9LCBmdW5jdGlvbiAoZXJyOiBNb25nb0Vycm9yLCByZXN1bHQ6IERlbGV0ZVdyaXRlT3BSZXN1bHRPYmplY3QpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChlcnIpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXMuc3RhdHVzKEludGVybmFsU2VydmVyRXJyb3IpXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzLnNlbmQoSlNPTi5zdHJpbmdpZnkoeyBtZXNzYWdlOiBpbnNwZWN0KGVycikgfSwgbnVsbCwgMikpXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzLmVuZCgpXG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoIXJlc3VsdCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlcy5zdGF0dXMoQmFkUmVxdWVzdClcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXMuc2VuZChKU09OLnN0cmluZ2lmeSh7IG1lc3NhZ2U6IFwiRGVsZXRlIEZ1bmN0aW9uIEZhaWxlZFwiIH0sIG51bGwsIDIpKVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlcy5lbmQoKVxuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzLnN0YXR1cyhPSylcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXMuc2VuZChKU09OLnN0cmluZ2lmeSh7IG1lc3NhZ2U6IFwiU2NoZWR1bGUgRGVsZXRlZCBTdWNjZXNzZnVsbHkgXCIgfSwgbnVsbCwgMikpXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzLmVuZCgpXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coXCIxIGRvY3VtZW50IGRlbGV0ZWRcIik7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgIH1cbiAgICB9KVxufTtcblxubW9kdWxlLmV4cG9ydHMucmVtb3ZlSW50ZXJ2YWwgPSBmdW5jdGlvbiAocmVxOiBhcGkuUmVxdWVzdCAmIHN3YWdnZXJUb29scy5Td2FnZ2VyMjBSZXF1ZXN0PFJlbW92ZUludGVydmFsUGF5bG9hZD4sIHJlczogZXhwcmVzcy5SZXNwb25zZSkge1xuXG4gICAgLy8gcHJpbnQgb3V0IHRoZSBwYXJhbXMgXG4gICAgY29uc29sZS5sb2codXRpbC5pbnNwZWN0KHJlcS5zd2FnZ2VyLnBhcmFtcywgZmFsc2UsIEluZmluaXR5LCB0cnVlKSlcbiAgICByZXMuc2V0SGVhZGVyKCdDb250ZW50LVR5cGUnLCAnYXBwbGljYXRpb24vanNvbicpXG5cbiAgICB2YXIgcmVtb3ZlaW50ZXJ2YWxPYmplY3QgPSByZXEuc3dhZ2dlci5wYXJhbXMucmVtb3ZlaW50ZXJ2YWwudmFsdWU7XG5cbiAgICAvKiBDaGVjayB0aGF0IHdlJ3JlIGxvZ2dlZCBpblxuICAgIGlmICghcmVxLnNlc3Npb24gfHwgIXJlcS5zZXNzaW9uLnVzZXJuYW1lKSB7XG4gICAgICAgIC8vIG5vIHNlc3Npb24gb3IgeWVzIHNlc3Npb24gYW5kIG5vIHVzZXJuYW1lXG4gICAgICAgIHJlcy5zdGF0dXMoQmFkUmVxdWVzdClcbiAgICAgICAgcmVzLnNlbmQoSlNPTi5zdHJpbmdpZnkoeyBtZXNzYWdlOiBcIllvdSBhcmUgbm90IGN1cnJlbnRseSBsb2dnZWQgaW4sIGxvZ2luIGluIHRvIHJlbW92ZSBpbnRlcnZhbFwiIH0sIG51bGwsIDIpKVxuICAgICAgICByZXMuZW5kKClcbiAgICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICAqL1xuICAgIC8vIENoZWNrIHRoYXQgdGhlIHNjaGVkdWxlIGV4aXN0cyBhbmQgYWN0dWFsbHkgYmVsb25ncyB0byB0aGlzIHNjaGVkdWxlci5cbiAgICBkYi5TY2hlZHVsZS5maW5kT25lKHsgX2lkOiBuZXcgTW9uZ29PYmplY3RJRChyZW1vdmVpbnRlcnZhbE9iamVjdC5zX2lkKSB9LCBmdW5jdGlvbiAoZXJyOiBNb25nb0Vycm9yLCByZXN1bHQ6IEFwaVNjaGVkdWxlIHwgbnVsbCkge1xuICAgICAgICAvLyBUT0RPOiBjaGVjayB0byBzZWUgaWYgcmVzdWx0IGlzIGEgdGhpbmcuXG4gICAgICAgIGlmIChlcnIpIHtcbiAgICAgICAgICAgIHJlcy5zdGF0dXMoSW50ZXJuYWxTZXJ2ZXJFcnJvcilcbiAgICAgICAgICAgIHJlcy5zZW5kKEpTT04uc3RyaW5naWZ5KHsgbWVzc2FnZTogaW5zcGVjdChlcnIpIH0sIG51bGwsIDIpKVxuICAgICAgICAgICAgcmVzLmVuZCgpXG4gICAgICAgIH1cbiAgICAgICAgaWYgKCFyZXN1bHQpIHtcbiAgICAgICAgICAgIHJlcy5zdGF0dXMoQmFkUmVxdWVzdClcbiAgICAgICAgICAgIHJlcy5zZW5kKEpTT04uc3RyaW5naWZ5KHsgbWVzc2FnZTogXCJTY2hlZHVsZSBEb2VzbnQgRXhpc3RcIiB9LCBudWxsLCAyKSlcbiAgICAgICAgICAgIHJlcy5lbmQoKVxuICAgICAgICB9XG4gICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgLy8gVE9ETzogY2hlY2sgdG8gc2VlIGlmIFNjaGVkdWxlIGJlbG9uZ3MgdG8gdGhpcyB1c2VyLlxuICAgICAgICAgICAgICAgIGlmICghcmVzdWx0LnNjaGVkdWxlcklELmVxdWFscyhyZXEuc2Vzc2lvbi5sb2dpZCkpIHtcbiAgICAgICAgICAgICAgICAgICAgcmVzLnN0YXR1cyhCYWRSZXF1ZXN0KVxuICAgICAgICAgICAgICAgICAgICByZXMuc2VuZChKU09OLnN0cmluZ2lmeSh7IG1lc3NhZ2U6IFwiVGhpcyBzY2hlZHVsZSBkb2VzbnQgYmVsb25nIHRvIHRoZSBjdXJyZW50IHVzZXJcIiB9LCBudWxsLCAyKSlcbiAgICAgICAgICAgICAgICAgICAgcmVzLmVuZCgpXG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgZGIuUmVzZXJ2YXRpb24uaW5zZXJ0T25lKHJlbW92ZWludGVydmFsT2JqZWN0LCBmdW5jdGlvbiAoZXJyOiBNb25nb0Vycm9yLCByZXN1bHQ6IEluc2VydE9uZVdyaXRlT3BSZXN1bHQpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoZXJyKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlcy5zdGF0dXMoSW50ZXJuYWxTZXJ2ZXJFcnJvcilcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzLnNlbmQoSlNPTi5zdHJpbmdpZnkoeyBtZXNzYWdlOiBpbnNwZWN0KGVycikgfSwgbnVsbCwgMikpXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlcy5lbmQoKVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIXJlc3VsdCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXMuc3RhdHVzKEJhZFJlcXVlc3QpXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlcy5zZW5kKEpTT04uc3RyaW5naWZ5KHsgbWVzc2FnZTogXCJSZW1vdmUgSW50ZXJ2YWwgRnVuY3Rpb24gRmFpbGVkXCIgfSwgbnVsbCwgMikpXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlcy5lbmQoKVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzLnN0YXR1cyhPSylcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzLnNlbmQoSlNPTi5zdHJpbmdpZnkoeyBtZXNzYWdlOiBcIlJlbW92ZWQgSW50ZXJ2YWwgU3VjY2Vzc2Z1bGx5IFwiIH0sIG51bGwsIDIpKVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXMuZW5kKClcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgKVxufTtcbiJdfQ==
